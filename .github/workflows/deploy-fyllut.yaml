name: "Deploy 'fyllut'"
on:
  push:
    branches:
      - master
      - dev-deploy
      - experimental-deploy
env:
  IMAGE: "ghcr.io/${{ github.repository }}/${{ github.ref == 'refs/heads/master' && 'fyllut' || 'fyllut-dev' }}:${{ github.sha }}"
  IMAGE_FYLLUT_BASE: "ghcr.io/navikt/skjemabygging-formio/${{ github.ref == 'refs/heads/master' && 'fyllut-base' || 'fyllut-base-dev' }}"
  MONOREPO_BASE_URL: "https://raw.githubusercontent.com/navikt/skjemabygging-formio"
  PUSHER_APP_SECRET: ${{ secrets.PUSHER_APP_SECRET }}
  BYGGER_URL: "https://skjemabygging.nav.no"

concurrency: deploy-${{ github.ref }}

jobs:
  package-and-push-fyllut:
    name: "Package 'fyllut'"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '16.17.1'
      - name: Read monorepo commit sha
        run: echo "MONOREPO_GIT_SHA=$(cat MONOREPO)" >> $GITHUB_ENV
      - name: Login to GitHub Package Repository
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: "Build and publish Docker image"
        run: >
          docker build --pull --tag ${IMAGE}
          --build-arg image_fyllut_base=${IMAGE_FYLLUT_BASE}
          --build-arg git_sha=${{ github.sha }}
          --build-arg monorepo_git_sha=${{ env.MONOREPO_GIT_SHA }}
          --build-arg skjema_dir=forms
          --build-arg translation_dir=translations
          --build-arg resources_dir=resources .
          && docker push ${IMAGE}
      - name: "Notify job failure"
        if: ${{ github.ref == 'refs/heads/master' && failure() }}
        run: yarn && cat $GITHUB_EVENT_PATH | node bin/notifyDeploy.mjs failure

  deploy-fyllut-to-prod:
    name: "Deploy 'fyllut' to prod"
    if: github.ref == 'refs/heads/master'
    needs: "package-and-push-fyllut"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '16.17.1'
      - name: Fetch NAIS config
        run: bin/fetchNaisConfig.sh prod fyllut-config
      - name: "Deploy to prod"
        uses: "nais/deploy/actions/deploy@v1"
        env:
          "APIKEY": "${{ secrets.NAIS_DEPLOY_APIKEY }}"
          "CLUSTER": "prod-gcp"
          "RESOURCE": "./fyllut-config/config.yaml"
          "VARS": "./fyllut-config/prod.yaml"
      - name: "Notify job success"
        if: ${{ success() }}
        run: yarn && cat $GITHUB_EVENT_PATH | node bin/notifyDeploy.mjs success
      - name: "Notify job failure"
        if: ${{ failure() }}
        run: yarn && cat $GITHUB_EVENT_PATH | node bin/notifyDeploy.mjs failure

  notify-prod-deployment-failure:
    name: "Notify prod deployment failure"
    if: failure() && github.ref == 'refs/heads/master'
    needs: deploy-fyllut-to-prod
    runs-on: ubuntu-latest
    steps:
      - name: "Slack notification"
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_FOOTER: "Deploy av fyllut til prod har feilet."
          SLACK_COLOR: failure

  deploy-fyllut-to-dev:
    name: "Deploy 'fyllut' to dev"
    if: github.ref == 'refs/heads/dev-deploy'
    needs: "package-and-push-fyllut"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Fetch NAIS config
        run: bin/fetchNaisConfig.sh dev fyllut-config
      - name: "Deploy to dev"
        uses: "nais/deploy/actions/deploy@v1"
        env:
          "APIKEY": "${{ secrets.NAIS_DEPLOY_APIKEY }}"
          "CLUSTER": "dev-gcp"
          "RESOURCE": "./fyllut-config/config.yaml"
          "VARS": "./fyllut-config/dev.yaml"

  deploy-fyllut-delingslenke-to-dev:
    name: "Deploy 'fyllut'-delingslenke to dev"
    if: github.ref == 'refs/heads/dev-deploy'
    needs: "package-and-push-fyllut"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Fetch NAIS config
        run: bin/fetchNaisConfig.sh dev-delingslenke fyllut-config
      - name: "Deploy to dev"
        uses: "nais/deploy/actions/deploy@v1"
        env:
          "APIKEY": "${{ secrets.NAIS_DEPLOY_APIKEY }}"
          "CLUSTER": "dev-gcp"
          "RESOURCE": "./fyllut-config/config.yaml"
          "VARS": "./fyllut-config/dev-delingslenke.yaml"

  deploy-fyllut-experimental-to-dev:
    name: "Deploy 'fyllut'-experimental to dev"
    if: github.ref == 'refs/heads/experimental-deploy'
    needs: "package-and-push-fyllut"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Fetch NAIS config
        run: bin/fetchNaisConfig.sh dev-experimental fyllut-config
      - name: "Deploy to dev-experimental"
        uses: "nais/deploy/actions/deploy@v1"
        env:
          "APIKEY": "${{ secrets.NAIS_DEPLOY_APIKEY }}"
          "CLUSTER": "dev-gcp"
          "RESOURCE": "./fyllut-config/config.yaml"
          "VARS": "./fyllut-config/dev-experimental.yaml"

  notify-dev-deployment-failure:
    name: "Notify dev deployment failure"
    if: failure() && (github.ref == 'refs/heads/dev-deploy')
    needs: [deploy-fyllut-to-dev, deploy-fyllut-delingslenke-to-dev]
    runs-on: ubuntu-latest
    steps:
      - name: "Slack notification"
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_FOOTER: "Deploy av fyllut til dev har feilet. Undersøk om det kan påvirke neste publisering fra byggeren."
          SLACK_COLOR: "#ff9100"
